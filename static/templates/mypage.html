<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>마이 페이지</title>
    <link rel="stylesheet" href="/static/css/mypage.css">


    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">




    

</head>
<body>

    <header>
        <a href="http://localhost:5500/static/templates/home.html" class="logo">
            <img src="/static/img/logo.png" alt="logo" style="height: 100px;">
        </a>
    
        <nav>
            <a href="http://localhost:5500/static/templates/guide.html">Guides</a>
            <a href="http://localhost:5500/static/templates/search.html">Search</a>
            <a href="http://localhost:5500/static/templates/mypage.html">My profile</a>
            <div class="dropdown-container">
                <a href="#" class="classing">Classing</a>
                <div class="dropdown">
                    <a href="http://localhost:5500/static/templates/learning.html">Learning Video</a>
                    <a href="http://localhost:5500/static/templates/learned.html">Learned Video</a>
                </div>
            </div>
        </nav>
        <div class="auth">
            <div class="language-container">
                <a href="#" class="language">Language</a>
                <div class="language-dropdown">
                    <a href="http://localhost:5500/static/templates/homeKorean.html">Korean</a>
                    <a href="http://localhost:5500/static/templates/home.html">English</a>
                </div>
            </div>
            <a href="http://localhost:5500/static/templates/Loginnew.html" id="login-link">Login</a>
            <a href="http://localhost:5500/static/templates/signup.html" id="signup-link">Sign up</a>
            <a href="#" id="logout-link" style="display: none;">Logout</a>
        </div>
    </header>
    <hr>

    <div class="container">
        <div class="sidebar">
            <ul>
                <li><a href="#" onclick="showContent('myInfo')">내 정보</a></li>
                <li><a href="#" onclick="showContent('personalInfo')">개인정보 관리</a></li>
            </ul>
        </div>
        <div class="content">
            <div id="myInfo" class="content-section active">
                <div class="profile-header">
                    <strong>내 정보</strong>
                    <button onclick="showContent('')" class="back-button">← </button>
                </div>
                <div class="profile-container">
                    <div class="profile-box profile-left">
                        <div class="profile-image">
                            <img src="프로필이미지.jpg" alt="프로필 이미지">
                        </div>
                        <div class="profile-info">
                            <p>회원 정보</p>
                            
                            <p>이메일: <span id="userEmail">Loading...</span></p>
                            <p>최근로그인: <span id="userJoinDate">Loading...</span></p>
                        </div>
                    </div>
                </div>
            </div>

            <div id="personalInfo" class="content-section">
                <h2>개인정보 관리</h2>
                <form id="emailForm">
                    <label for="email">이메일 변경</label>
                    <input type="email" id="email" name="email" required>
                    <button type="button" onclick="updateEmail()">이메일 변경</button>
                </form>
                <form id="passwordForm">
                    <label for="password">새 비밀번호 입력</label>
                    <input type="password" id="password" name="password" required>
                    <label for="confirmPassword">새 비밀번호 확인</label>
                    <input type="password" id="confirmPassword" name="confirmPassword" required>
                    <button type="button" onclick="updatePassword()">비밀번호 변경</button>
                </form>
            </div>

            <div id="learnedVideos" class="content-section">
                <h2>학습한 영상 내역</h2>
                <ul id="videoList"></ul>
            </div>
        </div>
    </div>

    <script>

        


        // 사용자 정보를 서버에서 가져오는 함수
        function fetchUserData() {
            return fetch('/user-info')
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        alert(data.error);
                        window.location.href = '로그인.html'; // 로그인 페이지로 리디렉션
                    } else {
                        return data;
                    }
                });
        }

        // 사용자 정보를 페이지에 반영하는 함수
        function updateUserInfo() {
            fetchUserData().then(userData => {
                document.getElementById('userEmail').textContent = userData.email;
                document.getElementById('userJoinDate').textContent = new Date(userData.joinDate).toLocaleDateString();
            });
        }

        







        // 이메일 업데이트 기능
        function updateEmail() {
            const email = document.getElementById('email').value;
            const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

            if (!emailPattern.test(email)) {
                alert('유효하지 않은 이메일 형식입니다. 다시 확인해 주세요.');
                return;
            }
               
 //^  POST 요청을 보내고 서버에 데이터를 전송
            fetch('/update-email', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ email: email })
            })
            .then(response => response.json())
            .then(data => {
                alert(data.message);
                if (data.success) {
                    document.getElementById('userEmail').textContent = email; // 이메일 변경된 내용을 업데이트
                }
            })
            .catch(error => console.error('Error:', error));
        }

        // 비밀번호 업데이트 기능
        function updatePassword() {
            const password = document.getElementById('password').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            if (password !== confirmPassword) {
                alert('비밀번호가 일치하지 않습니다.');
                return;
            }

            fetch('/update-password', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ password: password })
            })
            .then(response => response.json())
            .then(data => {
                alert(data.message);
            })
            .catch(error => console.error('Error:', error));
        }

        // 학습한 영상 표시 함수
        const learnedVideos = [
            { title: "Video 1", date: "2024-07-01" },
            { title: "Video 2", date: "2024-07-02" },
            { title: "Video 3", date: "2024-07-03" },
        ];

        function displayLearnedVideos() {
            const videoList = document.getElementById('videoList');
            videoList.innerHTML = ''; 

            learnedVideos.slice(0, 20).forEach(video => {
                const listItem = document.createElement('li');
                listItem.textContent = `${video.title} - ${video.date}`;
                videoList.appendChild(listItem);
            });
        }

        document.addEventListener('DOMContentLoaded', function() {
            // 로그인 상태 확인 및 사용자 정보 로드
            fetch('/check-session')
                .then(response => response.json())
                .then(data => {
                    if (!data.loggedIn) {
                        alert('로그인 후 사용하실 수 있습니다.');
                        window.location.href = '로그인.html';
                    } else {
                        updateUserInfo();
                    }
                });

            // 학습한 영상 표시
            displayLearnedVideos();
        });



//^ 콘텐츠 섹션 전환 함수
function showContent(sectionId) {
    // 모든 섹션을 숨김
    const sections = document.querySelectorAll('.content-section');
    sections.forEach(section => {
        section.classList.remove('active');
    });

    // 선택된 섹션만 표시
    if (sectionId) {
        const activeSection = document.getElementById(sectionId);
        if (activeSection) {
            activeSection.classList.add('active');
        }
    }
}

// 뒤로가기 버튼 클릭 시 기본 섹션으로 돌아가는 함수
function showDefaultContent() {
    showContent('myInfo');
}


//로그인상태이면 헤더를  로그아웃으로 변경함 (로그인/로그아웃 상태처리)
$(document).ready(function() {
            // 로그인 상태 확인
            $.get('/check-login', function(data) {
                if (data.loggedIn) {
            $('#login-link').hide();
            $('#signup-link').hide();
            $('#logout-link').show();
        } else {
            $('#login-link').show();
            $('#signup-link').show();
            $('#logout-link').hide();
        }
            });

            // 로그아웃 처리
            $('#logout-link').on('click', function(e) {
                e.preventDefault();
                $.get('/logout', function(data) {
                    if (data.success) {
                        alert('로그아웃 되었습니다.');
                        location.reload(true); // 캐시를 무시하고 페이지 새로고침
                    }else {
                alert('로그아웃에 실패했습니다. 다시 시도해 주세요.');
            }

                });
            });
        });





    </script>
</body>
</html>
