<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>학습하기</title>
    <style>
        .video-container { text-align: center; margin-top: 20px; }
        .info { font-size: 18px; margin-top: 10px; }
        #loading-message { display: none; color: blue; font-size: 16px; }
    </style>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script><!--plotly 불러오기-->
</head>
<body>
    <h1>학습하기</h1>
    <div class="video-container">
        {% if video %}
            <div id="player"></div>
            <div class="info">
                <h2>{{ video.title }}</h2>
                <p>조회수: {{ video.viewCount }}회</p>
                <p>채널명: {{ video.channelTitle }}</p>
            </div>
        {% else %}
            <p style="color: red;">{{ error }}</p>
        {% endif %}
    </div>

    <div class="controls">
        <p>영상 지원 언어 선택: 
            <label><input type="radio" name="std_lang" value="KR" checked> 한국어</label>
            <label><input type="radio" name="std_lang" value="EN"> 영어</label>
        </p>
    
        <button id="save-learning-video" class="button">학습할 영상에 저장</button>
        <button id="analyze-video">분석하기</button>
        <div id="loading-message">로딩 중...</div>
    </div>

    <!-- 분석 결과를 표시할 영역 -->
    <div id="analysis-result" style="display: none;">
        <div class="result-section">
            <h2>Bloom 단계별 구간</h2>
            <ul class="stage-list" id="stage-segments"></ul>
        </div>
        <div class="result-section">
            <h2>주요 명사 키워드 (TF-IDF)</h2>
            <ul class="top-nouns" id="top-nouns"></ul>
        </div>
        <div class="result-section">
            <h2>Bloom 단계별 도넛 차트</h2>
            <div id="donut-chart"></div>
        </div>
        <div class="result-section">
            <h2>Bloom 단계별 시간 흐름 그래프</h2>
            <div id="dot-graph"></div>
        </div>
    </div>

    <a href="/search">검색 결과로 돌아가기</a>

    <script>
        var tag = document.createElement('script');
        tag.src = "https://www.youtube.com/iframe_api";
        var firstScriptTag = document.getElementsByTagName('script')[0];
        firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

        var player;
        function onYouTubeIframeAPIReady() {
            player = new YT.Player('player', {
                videoId: '{{ video.videoId }}',
                events: { 'onReady': onPlayerReady }
            });
        }
        function onPlayerReady(event) { event.target.playVideo(); }

        document.getElementById("save-learning-video").addEventListener("click", function() {
            const selectedLang = document.querySelector('input[name="std_lang"]:checked').value;
            fetch("{% url 'save_learning_video' %}", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": "{{ csrf_token }}"
                },
                body: JSON.stringify({
                    title: "{{ video.title }}",
                    vid: "{{ video.videoId }}",
                    setTime: "{{ video.duration_seconds }}",
                    uploader: "{{ video.channelTitle }}",
                    view_count: "{{ video.viewCount }}",
                    std_lang: selectedLang
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) alert("영상이 학습할 목록에 저장되었습니다.");
            })
            .catch(error => console.error("저장 중 오류:", error));
        });

        document.getElementById("analyze-video").addEventListener("click", function() {
            const selectedLang = document.querySelector('input[name="std_lang"]:checked').value;
            const videoId = "{{ video.videoId }}";
            const setTime = "{{ video.duration_seconds }}";

            console.log("Starting extraction...");
            document.getElementById("loading-message").style.display = "block";

            fetch("{% url 'run_extractor_and_save_to_db' %}", {  
                method: "POST",
                headers: { "Content-Type": "application/json", "X-CSRFToken": "{{ csrf_token }}" },
                body: JSON.stringify({
                    video_id: videoId,
                    setTime: setTime,
                    std_lang: selectedLang,
                    title: "{{ video.title }}",
                    uploader: "{{ video.channelTitle }}",
                    view_count: "{{ video.viewCount }}"
                }) 
            })
            .then(response => response.json())
            .then(data => {
                console.log("Extraction response:", data); 
                if (data.success) {
                    return runAnalysis(videoId);
                } else {
                    document.getElementById("loading-message").style.display = "none";
                    alert(data.error || "추출 중 오류가 발생했습니다.");
                }
            })
            .catch(error => {
                document.getElementById("loading-message").style.display = "none";
                console.error("추출 중 오류:", error);
                alert("추출 중 오류가 발생했습니다.");
            });
        });

        function runAnalysis(videoId) {
            console.log("Starting analysis for videoId:", videoId);

            const encodedVideoId = encodeURIComponent(videoId);
            fetch(`/run_analysis/${encodedVideoId}/`, {
                method: "GET",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": "{{ csrf_token }}"
                }
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById("loading-message").style.display = "none";
                console.log("Analysis response:", data);

                if (data.success) {
                    document.getElementById("analysis-result").style.display = "block";

                    const topNounsList = document.getElementById("top-nouns");
                    topNounsList.innerHTML = "";
                    data.top_nouns.forEach(noun => {
                        const li = document.createElement("li");
                        li.textContent = noun;
                        topNounsList.appendChild(li);
                    });

                    const stageSegmentsList = document.getElementById("stage-segments");
                    stageSegmentsList.innerHTML = "";
                    for (const [stage, segment] of Object.entries(data.stage_segments)) {
                        const li = document.createElement("li");
                        li.textContent = `${stage}: ${segment}`;
                        stageSegmentsList.appendChild(li);
                    }

                    // HTML에서 div 요소를 직접 가져와 변수로 저장
                    var donutChartDiv = document.getElementById('donut-chart');
                    var dotGraphDiv = document.getElementById('dot-graph');

                    // Plotly.newPlot을 호출할 때 변수로 전달
                    Plotly.newPlot(donutChartDiv, data.donut_chart.data, data.donut_chart.layout);
                    Plotly.newPlot(dotGraphDiv, data.dot_graph.data, data.dot_graph.layout);

                    console.log("Donut chart data:", data.donut_chart.data);
                    console.log("Donut chart layout:", data.donut_chart.layout);
                    console.log("Dot graph data:", data.dot_graph.data);
                    console.log("Dot graph layout:", data.dot_graph.layout);
            
                    alert("분석이 완료되었습니다!");
                } else {
                    alert(data.error || "분석 중 오류가 발생했습니다.");
                }
            })
            .catch(error => {
                document.getElementById("loading-message").style.display = "none";
                console.error("분석 중 오류:", error);
                 alert("분석 중 오류가 발생했습니다.");
            });
        }

    </script>
</body>
</html>
