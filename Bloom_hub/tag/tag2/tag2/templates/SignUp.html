<!DOCTYPE html>
<html lang="en">
<head>
    <meta name="csrf-token" content="{{ csrf_token }}">

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>회원가입</title>
    <link rel="stylesheet" href="/static/css/SignUp.css">

    <!-- jQuery 라이브러리 로드 -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

</head>
<body>
  <header>
    <a href="http://localhost:5500/static/templates/home.html" class="logo">
        <img src="/static/img/logo.png" alt="logo" style="height: 100px;">
    </a>

      
      <nav>
          <a href="http://localhost:5500/static/templates/guide.html">Guides</a>
          <a href="http://localhost:5500/static/templates/search.html">Search</a>
          <a href="http://localhost:5500/static/templates/mypage.html">My profile</a>
          <div class="dropdown-container">
              <a href="#" class="classing">Classing</a>
              <div class="dropdown">
                  <a href="http://localhost:5500/static/templates/learning.html">Learning Video</a>
                  <a href="http://localhost:5500/static/templates/learned.html">Learned Video</a>
              </div>
          </div>
      </nav>
      <div class="auth">
          <div class="language-container">
              <a href="#" class="language">Language</a>
              <div class="language-dropdown">
                  <a href="http://localhost:5500/static/templates/homeKorean.html">Korean</a>
                  <a href="http://localhost:5500/static/templates/home.html">English</a>
              </div>
          </div>
          <a href="http://localhost:5500/static/templates/loginnew.html">Login</a>
          <a href="http://localhost:5500/static/templates/signup.html">Sign up</a>
      </div>
  </header>
  <hr>

  <div class="box-container"> 
      <h1>SIGN UP</h1>
      <div class="description-container">
          <div id="description">회원가입을 하고 당신을 위한 맞춤서비스를 이용해 보세요 </div>
          <hr id="hr-green">

      </div>
      <ul class="links">
          <li>
              <!-- <a href="로그인.html" id="signin">SIGN UP</a> -->
                    <div id="ID">ID :</div>
          </li>
          <li>
                <div id="PassWord">PassWord :</div>
              <!-- <a href="회원가입.html" id="signup">SIGN UP</a> -->
          </li>
            
       
               <li> <div id="Repeat-PassWord">Repeat PW :</div></li>
            
       
                <li> <div id="name-inputd">Name :</div> </li>
            
            
                <li>    <div id="wiki-inputd">Wiki Api : </div> </li>
       
                <li>    <div id="youtube-inputd">Youtube Api : </div> </li>
       
           

      </ul>

      <!-- 회원가입 폼 -->
      <form id="signupForm"> <!-- action과 method를 제거,id로 전환 -->
        <!--^html에서 form으로보내는 id와 script에서 특정id의 동작이 같게  -->

            {% csrf_token %}             
        <div class="first-input input__block first-input__block">
            <input type="email" placeholder="Email" class="input" id="email" name="email" required />
        </div>
        <div class="input__block">
            <input type="password" placeholder="Password" class="input" id="password" name="password" required autocomplete="new-password" />
        </div>
        <div class="input__block">
            <input type="password" placeholder="Repeat password" class="input repeat__password" id="repeat__password" name="repeat__password" required autocomplete="new-password" />
        </div>
        <div class="input__block">
            <input type="text" placeholder="이름"  id="input-name" name="name">
        </div>
        
        <div class="input__block">
            <input type="text" placeholder="wikiApi키"  id="input-wikiApi" name="wikiApi">
        </div>

        <div class="input__block">
            <input type="text" placeholder="youtubeApi키"  id="input-youtubeApi" name="youtubeApi">
        </div>
        
        
        
        <button class="signin__btn" type="submit">가입하기</button>
      </form>

   

      <script>
         // 쿠키 값을 가져오는 함수 (CSRF 토큰을 포함)
         function getCookie(name) {
            let cookieValue = null;  // 쿠키 값 초기화
            // 브라우저에 쿠키가 존재하고 비어있지 않다면
            if (document.cookie && document.cookie !== '') {
                // 쿠키들을 세미콜론으로 분리하여 배열로 저장
                const cookies = document.cookie.split(';');
                // 모든 쿠키를 순회하면서 원하는 쿠키를 찾음
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim(); // 쿠키의 앞뒤 공백 제거
                    // 쿠키의 이름이 우리가 찾는 이름과 일치한다면
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        // 쿠키 값 디코딩하여 저장
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;  // 쿠키를 찾으면 반복 종료
                    }
                }
            }
            return cookieValue;  // 쿠키 값을 반환
        }
    // CSRF 토큰을 가져와서 변수에 저장 (보안 목적으로 서버에 POST 요청을 보낼 때 사용)
        const csrftoken = getCookie('csrftoken');
    
        // 회원가입 폼(submit 이벤트) 처리
        $('#signupForm').on('submit', function(e) {
            e.preventDefault(); // 폼의 기본 제출 동작을 막음 (페이지 새로고침 방지)
    
            // 비밀번호와 반복 입력된 비밀번호 값 가져오기
            const password = $('#password').val();
            const repeat__password = $('#repeat__password').val();
    
            // 두 비밀번호가 일치하지 않으면 경고창을 띄우고 제출을 막음
            if (password !== repeat__password) {
                alert('비밀번호를 동일하게 입력해주세요.!');
                return;  // 함수 종료
            }
    
            // 회원가입 폼 데이터 (이메일, 비밀번호 등)를 객체 형태로 저장
            const formData = {
                email: $('#email').val(),  // 이메일 입력 값
                password: password,  // 비밀번호 입력 값
                repeat__password: repeat__password,  // 반복 입력된 비밀번호
                name : $('#input-name').val(),
                wiki_api: $('#input-wikiApi').val(),        //^ 소괄호 : 인풋 id
                youtube_api: $('#input-youtubeApi').val(),
            };
    
            // AJAX를 사용하여 서버에 비동기적으로 회원가입 요청을 보냄
            $.ajax({
                type: 'POST',  // POST 요청으로 데이터를 서버에 전송
                url: '/signup/',  // 서버의 회원가입 URL 경로 (Django에서 설정한 URL과 맞춰야 함)
                data: JSON.stringify(formData),  // JSON 형식으로 폼 데이터를 서버에 전송
                contentType: 'application/json',  // 요청 데이터의 형식을 JSON으로 설정
                beforeSend: function(xhr) {
                    // 요청을 보내기 전에 CSRF 토큰을 헤더에 추가 (보안 필수 사항)
                    xhr.setRequestHeader('X-CSRFToken', csrftoken);
                },


                // 요청 성공 시 실행되는 콜백 함수
                success: function(response) {
                    console.log('Server response:', response);  // 서버의 응답을 콘솔에 출력하여 확인

                    // 서버 응답이 성공일 경우
                    if (response.success) {
                        alert('회원가입에 성공했습니다!');  // 성공 메시지 표시
                        window.location.href = '/home/';  // 성공 후 home.html로 리다이렉트
                    } else {
                        // 서버에서 오류 메시지를 반환하거나 실패한 경우 처리
                        alert(response.message || '회원가입에 실패했습니다. 다시 시도해주세요.- html');
                    }
                },
                // 요청 실패 시 실행되는 콜백 함수
                error: function(xhr) {
                    console.log('Error response:', xhr);  // 오류 응답을 콘솔에 출력하여 확인

                    // 서버에서 반환된 오류 메시지가 있으면 이를 표시하고, 없으면 기본 메시지 출력
                    const errorMessage = xhr.responseJSON ? xhr.responseJSON.message : '회원가입 오류가 발생했습니다.-html';
                    alert(errorMessage);  // 오류 메시지 표시
                }
            });
        });
        </script>
</body>
</html>
